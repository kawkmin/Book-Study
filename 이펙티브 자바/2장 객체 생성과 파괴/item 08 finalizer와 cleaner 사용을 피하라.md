# item 08 finalizer와 cleaner 사용을 피하라

# 요약

`finalizer`와 `cleaner`를 사용해서 객체 사용이 끝나는 시점에 소멸하게 로직을 짜지말자.

GC의 대상이 될 뿐, 즉시 수거해가는게 아니고 엄청 많은 단점이 있음.

그런 로직이 필요하면 `AutoCloseable` 를 고려해보자.

# 주요 내용

자바의 두 가지 객체 소멸자 `finalizer` 와 `cleaner` 가 있지만, 사용을 지양해야한다.

둘의 차이는 `cleaner` 는 자신의 스레드를 제어할 수 있어서, 비교적 덜 위험.

## 지양해야하는 이유

### 1. 즉시 수행된다는 보장이 없음.

언제 실행될 지 알 수 없으며 시간이 얼마나 걸릴지는 아무도 모른다.

⇒ ***즉 원하는 시점에 실행하게 하는 작업은 절대 할 수 없다.***

```java
1.파일 리소스를 반납하는 작업을 처리한다면 그 파일 리소스가 언제 처리 될지 알 수 없다.
    2.반납이 되지 않아 새로운 파일을 열지 못 하는 상황이 발생할 수 있다.
    3.동시에 열 수 있는 파일 개수가 제한되어 있다.
```

### 2. 얼마나 빠르게 실행될지 알 수 없음.

GC에 따라 얼마나 신속히 수행될지 달라지고 예측 불가능.

프로그래머가 테스트한 JVM에선 완벽하게 동작하여도 고객의 시스템에선 재앙을 일으킬 수 있다.

### 3. 우선순위가 낮고, 실행이 안될 수 있음.

우선순위가 낮아 계속 쌓여 `OutOfMemoryError` 발생할 수 있고, 수행 여부조차 보장하지 않기 때문에 실행이 안될 수 있음 (영속성 저장 등에 절대 사용 X)

### 4. 예외를 무시하며, 작업이 남아도 즉시 종료됨.

스택 추적이 불가능해질 수 있음. (`cleaner`는 쓰레드를 통제해 문제없음)

### 5. 심각한 성능 문제.

GC에게 효율을 떨어지게함.

### 6. 보안 문제.

생성이나 직렬화 과정에서 에외가 발생하면 생성되다 만 객체에서 악의적인 하위 클래스의 `finalizer`가 수행될 수 있게 된다.

## `finalizer`대체재는?

**⇒ `AutoCloseable` 을 구현 및 close 메서드 호출**

- close 메서드에서 객체 유요하지 않음을 필드에 기록 후, 그 필드를 통해 닫힌 객체를 부르면 예외 발생시키기.

## 그나마 사용할 수 있는 곳

### 1. 안정망 역할

자원의 소유자가 close 메서드를 호출하지 않는 것에 대비하는 안정망 역할을 할 수는 있지만, 비용 때문에 신중히 고려해야함.

### 2. 네이티브 자원 정리

`네이티브 피어`란 일반 자바 객체가 네이티브 메서드를 통해 기능을 위임한 네이티브 객체를 말한다. 그 결과 자바 피어를 회수할 때 네이티브 객체까지 회수하지 못
한다. ⇒ `finalizer` 사용.

성능 저하를 감당할 수 없거나 자원을 즉시 회수해야 한다면 close 메서드를 사용해야 한다.

# 질문 및 추가